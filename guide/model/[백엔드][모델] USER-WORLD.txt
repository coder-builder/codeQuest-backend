================================================================================
                        UserWorld ëª¨ë¸ ì™„ì „ ì •ë¦¬
================================================================================

ì‘ì„±ì¼: 2025-11-06
íŒŒì¼: worlds/models.py


================================================================================
ğŸ“¦ ëª¨ë¸ ê°œìš”
================================================================================

[ëª©ì ]
ì‚¬ìš©ìë³„ ì›”ë“œ í•™ìŠµ ì§„í–‰ ìƒí™© ì¶”ì 
ê° ì‚¬ìš©ìê°€ ì–´ë–¤ ì›”ë“œë¥¼ í•™ìŠµ ì¤‘ì´ê³ , ì–´ë””ê¹Œì§€ ì§„í–‰í–ˆëŠ”ì§€ ê´€ë¦¬

[ìœ„ì¹˜]
Django App: worlds
íŒŒì¼: worlds/models.py
í…Œì´ë¸”ëª…: worlds_userworld

[íŠ¹ì§•]
- Userì™€ Worldì˜ ë‹¤ëŒ€ë‹¤(M:N) ì¤‘ê°„ í…Œì´ë¸”
- unique_togetherë¡œ (user, world) ì¡°í•© ìœ ì¼ì„± ë³´ì¥
- ì§„í–‰ë¥ , ë§ˆì§€ë§‰ ê³µë¶€ ì‹œê°„ ë“± ì¶”ì 


================================================================================
ğŸ—‚ï¸ í•„ë“œ êµ¬ì¡°
================================================================================

user (ForeignKey)
â”œâ”€ ëŒ€ìƒ: settings.AUTH_USER_MODEL (users.User)
â”œâ”€ on_delete: CASCADE
â”œâ”€ related_name: 'user_worlds'
â”œâ”€ ì„¤ëª…: ì‚¬ìš©ì
â””â”€ ì—­ì°¸ì¡°: user.user_worlds.all()

world (ForeignKey)
â”œâ”€ ëŒ€ìƒ: World
â”œâ”€ on_delete: CASCADE
â”œâ”€ related_name: 'user_progresses'
â”œâ”€ ì„¤ëª…: ì›”ë“œ
â””â”€ ì—­ì°¸ì¡°: world.user_progresses.all()

is_unlocked (BooleanField)
â”œâ”€ ê¸°ë³¸ê°’: False
â”œâ”€ ì„¤ëª…: ì ê¸ˆ í•´ì œ ì—¬ë¶€ (ì‚¬ìš©ìë³„)
â””â”€ ìš©ë„: ì‚¬ìš©ìê°€ ì´ ì›”ë“œì— ì ‘ê·¼ ê°€ëŠ¥í•œì§€

completed_stage (IntegerField)
â”œâ”€ ê¸°ë³¸ê°’: 0
â”œâ”€ ì„¤ëª…: ì™„ë£Œí•œ ìŠ¤í…Œì´ì§€ ìˆ˜
â””â”€ ì—…ë°ì´íŠ¸: update_progress() ë©”ì„œë“œ í˜¸ì¶œ ì‹œ

last_studied_at (DateTimeField)
â”œâ”€ null/blank: True
â”œâ”€ ì„¤ëª…: ë§ˆì§€ë§‰ ê³µë¶€ ì‹œê°„
â”œâ”€ ì—…ë°ì´íŠ¸: touch() ë©”ì„œë“œ í˜¸ì¶œ ì‹œ
â””â”€ ìš©ë„: ìµœê·¼ í•™ìŠµ ì›”ë“œ ì •ë ¬

created_at (DateTimeField)
â”œâ”€ ìë™ ìƒì„±: auto_now_add=True
â”œâ”€ ì„¤ëª…: ì‹œì‘ ì‹œê°„
â””â”€ ë³„ì¹­: started_at (property)

updated_at (DateTimeField)
â”œâ”€ ìë™ ì—…ë°ì´íŠ¸: auto_now=True
â”œâ”€ ì„¤ëª…: ìˆ˜ì • ì‹œê°„
â””â”€ ìë™ ê°±ì‹ 


================================================================================
âš™ï¸ Meta ì„¤ì •
================================================================================

ordering = ['-last_studied_at', '-created_at']
â”œâ”€ ì •ë ¬ ìˆœì„œ: ìµœê·¼ ê³µë¶€í•œ ì›”ë“œê°€ ë§¨ ìœ„
â”œâ”€ 1ìˆœìœ„: last_studied_at (ë‚´ë¦¼ì°¨ìˆœ)
â””â”€ 2ìˆœìœ„: created_at (ë‚´ë¦¼ì°¨ìˆœ)

unique_together = (('user', 'world'),)
â”œâ”€ ì œì•½ì¡°ê±´: (ì‚¬ìš©ì, ì›”ë“œ) ì¡°í•© ìœ ì¼
â””â”€ íš¨ê³¼: í•œ ì‚¬ìš©ìëŠ” ê°™ì€ ì›”ë“œì— ëŒ€í•´ 1ê°œì˜ UserWorldë§Œ ê°€ëŠ¥

verbose_name = "ì‚¬ìš©ì ì½”ë”© ì–¸ì–´ ì›”ë“œ"
verbose_name_plural = "ì‚¬ìš©ì ì›”ë“œ ì§„í–‰ ì‚¬í•­ ëª©ë¡"


================================================================================
ğŸ“Š í”„ë¡œí¼í‹° (Properties)
================================================================================

[@property] total_stage
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ê¸°ëŠ¥: ì›”ë“œ ë‚´ ì´ ìŠ¤í…Œì´ì§€ ìˆ˜ë¥¼ ë™ì ìœ¼ë¡œ ê³„ì‚°
ë°˜í™˜: int
ìë™ ì‹¤í–‰: âŒ (ì ‘ê·¼ ì‹œë§Œ)

êµ¬í˜„:
    @property
    def total_stage(self):
        return self.world.stages.count()

ì‚¬ìš©ë²•:
    user_world = UserWorld.objects.get(user=user, world=python)
    total = user_world.total_stage
    # ê²°ê³¼: 5

íŠ¹ì§•:
    âœ“ í•„ë“œê°€ ì•„ë‹ˆë¼ ê³„ì‚°ëœ ê°’
    âœ“ Worldì˜ stagesë¥¼ COUNT ì¿¼ë¦¬
    âœ“ í•­ìƒ ìµœì‹  ê°’ (Stage ì¶”ê°€/ì‚­ì œ ì‹œ ìë™ ë°˜ì˜)

ì£¼ì˜ì‚¬í•­:
    âš ï¸ ë§¤ë²ˆ DB ì¿¼ë¦¬ ë°œìƒ
    âš ï¸ ë°˜ë³µ ì‚¬ìš© ì‹œ ë³€ìˆ˜ì— ì €ì¥ ê¶Œì¥


[@property] progress_percentage
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ê¸°ëŠ¥: ì›”ë“œ ì§„í–‰ë¥ ì„ í¼ì„¼íŠ¸ë¡œ ê³„ì‚°
ë°˜í™˜: int (0-100)
ìë™ ì‹¤í–‰: âŒ

êµ¬í˜„:
    @property
    def progress_percentage(self):
        if self.total_stage == 0:
            return 0
        return int((self.completed_stage / self.total_stage) * 100)

ì‚¬ìš©ë²•:
    user_world = UserWorld.objects.get(user=user, world=python)
    progress = user_world.progress_percentage
    # ê²°ê³¼: 60 (5ê°œ ì¤‘ 3ê°œ ì™„ë£Œ)

ê³„ì‚°ì‹:
    (ì™„ë£Œí•œ ìŠ¤í…Œì´ì§€ / ì „ì²´ ìŠ¤í…Œì´ì§€) * 100

ì˜ˆì‹œ:
    completed_stage = 3, total_stage = 5
    â†’ (3 / 5) * 100 = 60%


[@property] started_at
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ê¸°ëŠ¥: ì‹œì‘ ì‹œê°„ ë³„ì¹­ (created_atê³¼ ë™ì¼)
ë°˜í™˜: datetime
ìë™ ì‹¤í–‰: âŒ

êµ¬í˜„:
    @property
    def started_at(self):
        return self.created_at

ì‚¬ìš©ë²•:
    user_world = UserWorld.objects.get(user=user, world=python)
    started = user_world.started_at
    # user_world.created_atê³¼ ë™ì¼í•œ ê°’

ìš©ë„:
    ë” ëª…í™•í•œ ì˜ë¯¸ì˜ ë³„ì¹­ ì œê³µ


================================================================================
ğŸ”§ ë©”ì„œë“œ (Methods)
================================================================================

[ë©”ì„œë“œ] update_progress()
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ê¸°ëŠ¥: ì™„ë£Œí•œ ìŠ¤í…Œì´ì§€ ìˆ˜ë¥¼ ì¬ê³„ì‚°í•˜ì—¬ ì—…ë°ì´íŠ¸
ë§¤ê°œë³€ìˆ˜: ì—†ìŒ
ë°˜í™˜: None
ìë™ ì‹¤í–‰: âŒ (ëª…ì‹œì  í˜¸ì¶œ í•„ìš”!)

êµ¬í˜„:
    def update_progress(self):
        self.completed_stage = UserStageProgress.objects.filter(
            user=self.user,
            stage__world=self.world,
            is_completed=True
        ).count()
        self.save(update_fields=['completed_stage'])

ë™ì‘:
    1. UserStageProgressì—ì„œ ì¡°ê±´ ê²€ìƒ‰:
       - user = ì´ ì‚¬ìš©ì
       - stage__world = ì´ ì›”ë“œ
       - is_completed = True
    2. COUNTë¡œ ê°œìˆ˜ ì„¸ê¸°
    3. completed_stage í•„ë“œ ì—…ë°ì´íŠ¸
    4. DB ì €ì¥ (completed_stageë§Œ)

í˜¸ì¶œ ì‹œì :
    âœ“ ì‚¬ìš©ìê°€ ìŠ¤í…Œì´ì§€ë¥¼ ì™„ë£Œí–ˆì„ ë•Œ
    âœ“ ì§„í–‰ ìƒí™©ì„ ë™ê¸°í™”í•´ì•¼ í•  ë•Œ
    âœ“ ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰ë¥  ì¬ê³„ì‚°í•  ë•Œ

ì‚¬ìš© ì˜ˆì‹œ:
    # ìŠ¤í…Œì´ì§€ ì™„ë£Œ í›„
    stage_progress = UserStageProgress.objects.get(...)
    stage_progress.is_completed = True
    stage_progress.save()
    
    # UserWorld ì—…ë°ì´íŠ¸
    user_world = UserWorld.objects.get(user=user, world=world)
    user_world.update_progress()  # completed_stage ì¬ê³„ì‚°


[ë©”ì„œë“œ] touch()
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ê¸°ëŠ¥: ë§ˆì§€ë§‰ ê³µë¶€ ì‹œê°„ ì—…ë°ì´íŠ¸
ë§¤ê°œë³€ìˆ˜: ì—†ìŒ
ë°˜í™˜: None
ìë™ ì‹¤í–‰: âŒ (ëª…ì‹œì  í˜¸ì¶œ í•„ìš”!)

êµ¬í˜„:
    def touch(self):
        self.last_studied_at = timezone.now()
        self.save(update_fields=['last_studied_at'])

ë™ì‘:
    1. last_studied_atì„ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì„¤ì •
    2. DB ì €ì¥ (last_studied_atë§Œ)

í˜¸ì¶œ ì‹œì :
    âœ“ ì‚¬ìš©ìê°€ ë ˆìŠ¨ì„ í’€ì—ˆì„ ë•Œ
    âœ“ í•™ìŠµ í™œë™ì´ ìˆì„ ë•Œ
    âœ— ë‹¨ìˆœ ì¡°íšŒëŠ” touch ì•ˆ í•¨

ì‚¬ìš© ì˜ˆì‹œ:
    # ë ˆìŠ¨ ì™„ë£Œ í›„
    user_world = UserWorld.objects.get(user=user, world=world)
    user_world.touch()
    # last_studied_atì´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸
    
    # ì´ì œ ì´ ì›”ë“œê°€ "ìµœê·¼ í•™ìŠµ" ë§¨ ìœ„ë¡œ!

ì¤‘ìš”:
    âš ï¸ ì‹¤ì œ í•™ìŠµ í™œë™ë§Œ ê¸°ë¡
    âš ï¸ ì¡°íšŒ/íƒìƒ‰ì€ touch í•˜ì§€ ì•ŠìŒ


[ë©”ì„œë“œ] __str__()
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ê¸°ëŠ¥: ë¬¸ìì—´ í‘œí˜„
ë°˜í™˜: f"{self.user.username} - {self.world.title}"
ì˜ˆì‹œ: "user1 - Python", "admin - JavaScript"


================================================================================
ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°
================================================================================

CREATE TABLE worlds_userworld (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    world_id BIGINT NOT NULL,
    is_unlocked TINYINT(1) NOT NULL DEFAULT 0,
    completed_stage INT NOT NULL DEFAULT 0,
    last_studied_at DATETIME(6) NULL,
    created_at DATETIME(6) NOT NULL,
    updated_at DATETIME(6) NOT NULL,
    UNIQUE KEY unique_user_world (user_id, world_id),
    FOREIGN KEY (user_id) REFERENCES users_user(id),
    FOREIGN KEY (world_id) REFERENCES worlds_world(id)
);


================================================================================
ğŸ¯ ì‚¬ìš© ì˜ˆì‹œ
================================================================================

[1. UserWorld ìƒì„± (ì‹œì‘)]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
from django.utils import timezone

# get_or_create ì‚¬ìš© (ì¤‘ë³µ ë°©ì§€)
user_world, created = UserWorld.objects.get_or_create(
    user=user,
    world=python_world,
    defaults={
        'is_unlocked': True,
        'started_at': timezone.now()
    }
)

if created:
    print("ìƒˆë¡œìš´ ì›”ë“œ ì‹œì‘!")
else:
    print("ì´ë¯¸ ì‹œì‘í•œ ì›”ë“œ")


[2. ì§„í–‰ ìƒí™© ì¡°íšŒ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user_world = UserWorld.objects.get(user=user, world=python_world)

print(f"ì „ì²´ ìŠ¤í…Œì´ì§€: {user_world.total_stage}")
print(f"ì™„ë£Œ ìŠ¤í…Œì´ì§€: {user_world.completed_stage}")
print(f"ì§„í–‰ë¥ : {user_world.progress_percentage}%")
print(f"ë§ˆì§€ë§‰ ê³µë¶€: {user_world.last_studied_at}")


[3. ë ˆìŠ¨ ì™„ë£Œ í›„ ì—…ë°ì´íŠ¸]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def complete_lesson(user, lesson):
    """ë ˆìŠ¨ ì™„ë£Œ ì²˜ë¦¬"""
    world = lesson.stage.world
    
    # UserWorld ê°€ì ¸ì˜¤ê¸°
    user_world, _ = UserWorld.objects.get_or_create(
        user=user,
        world=world,
        defaults={'is_unlocked': True}
    )
    
    # ë§ˆì§€ë§‰ ê³µë¶€ ì‹œê°„ ì—…ë°ì´íŠ¸
    user_world.touch()
    
    # ì§„í–‰ë¥  ì¬ê³„ì‚°
    user_world.update_progress()


[4. ì‚¬ìš©ìì˜ ëª¨ë“  ì›”ë“œ ì¡°íšŒ (ìµœê·¼ í•™ìŠµ ìˆœ)]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user_worlds = UserWorld.objects.filter(
    user=user,
    is_unlocked=True
).select_related('world')

for uw in user_worlds:
    print(f"{uw.world.title}: {uw.progress_percentage}%")


[5. íŠ¹ì • ì›”ë“œ ì§„í–‰ë¥  í™•ì¸]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try:
    user_world = UserWorld.objects.get(user=user, world=python_world)
    progress = user_world.progress_percentage
    print(f"Python ì§„í–‰ë¥ : {progress}%")
except UserWorld.DoesNotExist:
    print("ì•„ì§ Pythonì„ ì‹œì‘í•˜ì§€ ì•ŠìŒ")


================================================================================
ğŸŒ API Serializer ì˜ˆì‹œ
================================================================================

# worlds/serializers.py

from rest_framework import serializers
from .models import UserWorld

class UserWorldSerializer(serializers.ModelSerializer):
    world_title = serializers.CharField(source='world.title', read_only=True)
    world_icon = serializers.CharField(source='world.icon', read_only=True)
    total_stage = serializers.IntegerField(read_only=True)
    progress_percentage = serializers.IntegerField(read_only=True)
    started_at = serializers.DateTimeField(read_only=True)
    
    class Meta:
        model = UserWorld
        fields = [
            'id',
            'world',
            'world_title',
            'world_icon',
            'is_unlocked',
            'completed_stage',
            'total_stage',
            'progress_percentage',
            'last_studied_at',
            'started_at',
            'created_at'
        ]
        read_only_fields = [
            'completed_stage',
            'last_studied_at',
            'created_at'
        ]


[API ì‘ë‹µ ì˜ˆì‹œ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{
    "id": 1,
    "world": 1,
    "world_title": "Python",
    "world_icon": "ğŸ",
    "is_unlocked": true,
    "completed_stage": 3,
    "total_stage": 5,
    "progress_percentage": 60,
    "last_studied_at": "2025-11-04T14:30:00Z",
    "started_at": "2025-11-01T10:00:00Z",
    "created_at": "2025-11-01T10:00:00Z"
}


================================================================================
ğŸ® ì‹¤ì „ í™œìš© ì‹œë‚˜ë¦¬ì˜¤
================================================================================

[ì‹œë‚˜ë¦¬ì˜¤ 1: í™ˆ í™”ë©´ - ìµœê·¼ í•™ìŠµ ì›”ë“œ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@api_view(['GET'])
def recent_worlds(request):
    """ìµœê·¼ í•™ìŠµí•œ ì›”ë“œ ëª©ë¡"""
    user_worlds = UserWorld.objects.filter(
        user=request.user,
        is_unlocked=True
    ).select_related('world')[:3]  # ìµœê·¼ 3ê°œ
    
    serializer = UserWorldSerializer(user_worlds, many=True)
    return Response(serializer.data)


[ì‹œë‚˜ë¦¬ì˜¤ 2: ì›”ë“œ ì‹œì‘í•˜ê¸°]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@api_view(['POST'])
def start_world(request, world_id):
    """ì›”ë“œ ì‹œì‘í•˜ê¸°"""
    world = World.objects.get(id=world_id)
    
    user_world, created = UserWorld.objects.get_or_create(
        user=request.user,
        world=world,
        defaults={'is_unlocked': True}
    )
    
    if created:
        return Response({
            'message': f'{world.title} ì›”ë“œë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤!',
            'data': UserWorldSerializer(user_world).data
        })
    else:
        return Response({
            'message': 'ì´ë¯¸ ì‹œì‘í•œ ì›”ë“œì…ë‹ˆë‹¤.',
            'data': UserWorldSerializer(user_world).data
        })


[ì‹œë‚˜ë¦¬ì˜¤ 3: í•™ìŠµ í†µê³„]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@api_view(['GET'])
def my_learning_stats(request):
    """ë‚´ í•™ìŠµ í†µê³„"""
    user_worlds = UserWorld.objects.filter(
        user=request.user,
        is_unlocked=True
    ).select_related('world')
    
    total_worlds = user_worlds.count()
    total_stages = sum(uw.total_stage for uw in user_worlds)
    completed_stages = sum(uw.completed_stage for uw in user_worlds)
    
    overall_progress = (
        int((completed_stages / total_stages) * 100)
        if total_stages > 0 else 0
    )
    
    return Response({
        'total_worlds': total_worlds,
        'total_stages': total_stages,
        'completed_stages': completed_stages,
        'overall_progress': overall_progress,
        'worlds': UserWorldSerializer(user_worlds, many=True).data
    })


================================================================================
âš ï¸ ì£¼ì˜ì‚¬í•­
================================================================================

[1. unique_together ì œì•½]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ê°™ì€ ì‚¬ìš©ìê°€ ê°™ì€ ì›”ë“œì— ëŒ€í•´ 2ê°œ ì´ìƒì˜ UserWorldë¥¼ ê°€ì§ˆ ìˆ˜ ì—†ìŒ

âŒ ì˜¤ë¥˜ ë°œìƒ:
    UserWorld.objects.create(user=user1, world=python)
    UserWorld.objects.create(user=user1, world=python)
    # IntegrityError!

âœ… ì•ˆì „í•œ ë°©ë²•:
    user_world, created = UserWorld.objects.get_or_create(
        user=user1,
        world=python
    )


[2. ìë™ ì‹¤í–‰ ì•ˆ ë¨]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸ update_progress()ì™€ touch()ëŠ” ìë™ìœ¼ë¡œ í˜¸ì¶œë˜ì§€ ì•ŠìŒ!
âš ï¸ ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œí•´ì•¼ í•¨!

ì˜ëª»ëœ ì˜ˆ:
    # ë ˆìŠ¨ ì™„ë£Œí•´ë„ UserWorldëŠ” ìë™ ì—…ë°ì´íŠ¸ ì•ˆ ë¨!
    lesson_progress.is_completed = True
    lesson_progress.save()
    # â†’ UserWorld.completed_stageëŠ” ê·¸ëŒ€ë¡œ!

ì˜¬ë°”ë¥¸ ì˜ˆ:
    lesson_progress.is_completed = True
    lesson_progress.save()
    
    user_world = UserWorld.objects.get(...)
    user_world.update_progress()  # âœ… ëª…ì‹œì  í˜¸ì¶œ
    user_world.touch()  # âœ… ëª…ì‹œì  í˜¸ì¶œ


[3. N+1 ì¿¼ë¦¬ ì£¼ì˜]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŒ N+1 ì¿¼ë¦¬ ë°œìƒ:
    user_worlds = UserWorld.objects.filter(user=user)
    for uw in user_worlds:
        print(uw.world.title)  # ê°ê° ì¿¼ë¦¬!
        print(uw.total_stage)  # ê°ê° ì¿¼ë¦¬!

âœ… select_related ì‚¬ìš©:
    user_worlds = UserWorld.objects.filter(user=user)\
        .select_related('world')
    for uw in user_worlds:
        print(uw.world.title)  # ì¡°ì¸ìœ¼ë¡œ í•œ ë²ˆì—!
        print(uw.total_stage)  # ì—¬ì „íˆ ê°ê° ì¿¼ë¦¬ (property)


[4. Property ë°˜ë³µ ì‚¬ìš©]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŒ ë§¤ë²ˆ DB ì¿¼ë¦¬:
    for i in range(10):
        print(user_world.total_stage)  # 10ë²ˆ ì¿¼ë¦¬!

âœ… ë³€ìˆ˜ì— ì €ì¥:
    total = user_world.total_stage  # 1ë²ˆ ì¿¼ë¦¬
    for i in range(10):
        print(total)  # ì¿¼ë¦¬ ì—†ìŒ


================================================================================
ğŸ“ ë°ì´í„° ì˜ˆì‹œ
================================================================================

[UserWorld ë°ì´í„° ìƒ˜í”Œ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user: user1
world: Python ğŸ
is_unlocked: True
completed_stage: 3
total_stage: 5 (propertyë¡œ ê³„ì‚°)
progress_percentage: 60% (propertyë¡œ ê³„ì‚°)
last_studied_at: 2025-11-04 14:30:00
started_at: 2025-11-01 10:00:00 (created_at ë³„ì¹­)


================================================================================
ğŸ”— ê´€ë ¨ ëª¨ë¸ ë§í¬
================================================================================

â†’ World: ì›”ë“œ ì •ë³´
â†’ User: ì‚¬ìš©ì ì •ë³´
â†’ UserStageProgress: ìŠ¤í…Œì´ì§€ë³„ ì§„í–‰ ìƒí™©
â†’ UserLessonProgress: ë ˆìŠ¨ë³„ ì§„í–‰ ìƒí™©


================================================================================
ë!
================================================================================
